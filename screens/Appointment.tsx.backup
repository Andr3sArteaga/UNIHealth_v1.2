// src/screens/Diary.tsx
import React, { useState, useMemo } from "react";
import styled from "styled-components/native";
import { Theme } from "../components/colors";
import { Ionicons } from "@expo/vector-icons";
import { useNavigation } from "@react-navigation/native";
import DiaryEntryModal, { DiaryEntry } from "../components/DiaryEntryModal";
import DiaryEntryCard from "../components/DiaryEntryCard";

interface CalendarDay {
  date: Date;
  label: string;
  isCurrentMonth: boolean;
  isSelected?: boolean;
  hasEntry?: boolean;
}

const weekDaysShort = ["Su", "Mo", "Tu", "We", "Th", "Fr", "Sa"];

// Helper function to compare dates
const isSameDay = (date1: Date, date2: Date): boolean => {
  return (
    date1.getFullYear() === date2.getFullYear() &&
    date1.getMonth() === date2.getMonth() &&
    date1.getDate() === date2.getDate()
  );
};

const Diary: React.FC = () => {
  const navigation = useNavigation<any>();
  const [selectedDate, setSelectedDate] = useState<Date>(new Date());
  const [currentMonth, setCurrentMonth] = useState<Date>(new Date());
  const [entries, setEntries] = useState<DiaryEntry[]>([]);
  const [modalVisible, setModalVisible] = useState(false);

  // Generate calendar days for the current month
  const calendarDays = useMemo(() => {
    const year = currentMonth.getFullYear();
    const month = currentMonth.getMonth();

    // First day of the month
    const firstDay = new Date(year, month, 1);
    const firstDayOfWeek = firstDay.getDay();

    // Last day of the month
    const lastDay = new Date(year, month + 1, 0);
    const lastDate = lastDay.getDate();

    const days: CalendarDay[] = [];

    // Add previous month's days
    const prevMonthLastDay = new Date(year, month, 0).getDate();
    for (let i = firstDayOfWeek - 1; i >= 0; i--) {
      const date = new Date(year, month - 1, prevMonthLastDay - i);
      days.push({
        date,
        label: String(prevMonthLastDay - i),
        isCurrentMonth: false,
      });
    }

    // Add current month's days
    for (let i = 1; i <= lastDate; i++) {
      const date = new Date(year, month, i);
      const hasEntry = entries.some((entry) =>
        isSameDay(new Date(entry.date), date)
      );
      days.push({
        date,
        label: String(i),
        isCurrentMonth: true,
        isSelected: isSameDay(date, selectedDate),
        hasEntry,
      });
    }

    // Add next month's days to fill the grid
    const remainingDays = 42 - days.length; // 6 rows * 7 days
    for (let i = 1; i <= remainingDays; i++) {
      const date = new Date(year, month + 1, i);
      days.push({
        date,
        label: String(i),
        isCurrentMonth: false,
      });
    }

    return days;
  }, [currentMonth, selectedDate, entries]);

  const formatMonthYear = (date: Date): string => {
    const months = [
      "January",
      "February",
      "March",
      "April",
      "May",
      "June",
      "July",
      "August",
      "September",
      "October",
      "November",
      "December",
    ];
    return `${months[date.getMonth()]} ${date.getFullYear()}`;
  };

  const formatSelectedDate = (date: Date): string => {
    const months = [
      "enero",
      "febrero",
      "marzo",
      "abril",
      "mayo",
      "junio",
      "julio",
      "agosto",
      "septiembre",
      "octubre",
      "noviembre",
      "diciembre",
    ];
    return `${date.getDate()} de ${months[date.getMonth()]
      } de ${date.getFullYear()}`;
  };

  const handlePreviousMonth = () => {
    setCurrentMonth(
      new Date(currentMonth.getFullYear(), currentMonth.getMonth() - 1, 1)
    );
  };

  const handleNextMonth = () => {
    setCurrentMonth(
      new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 1)
    );
  };

  const handleDateSelect = (day: CalendarDay) => {
    if (day.isCurrentMonth) {
      setSelectedDate(day.date);
    }
  };

  const handleCreateEntry = () => {
    setModalVisible(true);
  };

  const handleEntrySubmit = (entry: Omit<DiaryEntry, "id">) => {
    const newEntry: DiaryEntry = {
      ...entry,
      id: Date.now().toString(),
    };
    setEntries((prev) => [...prev, newEntry]);
  };

  const handleFilterPress = () => {
    // Future: Navigate to filters or open filter modal
  };

  // Get entries for the selected date
  const selectedDateEntries = useMemo(() => {
    return entries.filter((entry) =>
      isSameDay(new Date(entry.date), selectedDate)
    );
  }, [entries, selectedDate]);

  return (
    <Container>
      <ContentScroll
        contentContainerStyle={{
          paddingBottom: Theme.spacing.space10,
        }}
      >
        {/* HEADER SUPERIOR */}
        <TopHeader>
          <HeaderTitleRow activeOpacity={0.7}>
            <HeaderTitle>Diario Médico</HeaderTitle>
            <Ionicons
              name="chevron-down"
              size={18}
              color={Theme.colors.textSecondary}
              style={{ marginLeft: 4 }}
            />
          </HeaderTitleRow>

          <HeaderIconButton onPress={handleFilterPress} activeOpacity={0.7}>
            <Ionicons
              name="funnel-outline"
              size={22}
              color={Theme.colors.textSecondary}
            />
          </HeaderIconButton>
        </TopHeader>

        {/* CALENDARIO */}
        <CalendarCard>
          <CalendarHeaderRow>
            <MonthLabel>{formatMonthYear(currentMonth)}</MonthLabel>

            <MonthControls>
              <MonthArrowButton onPress={handlePreviousMonth}>
                <Ionicons
                  name="chevron-back"
                  size={18}
                  color={Theme.colors.textSecondary}
                />
              </MonthArrowButton>
              <MonthArrowButton onPress={handleNextMonth}>
                <Ionicons
                  name="chevron-forward"
                  size={18}
                  color={Theme.colors.textSecondary}
                />
              </MonthArrowButton>
            </MonthControls>
          </CalendarHeaderRow>

          <WeekDaysRow>
            {weekDaysShort.map((d) => (
              <WeekDayText key={d}>{d}</WeekDayText>
            ))}
          </WeekDaysRow>

          <DaysGrid>
            {calendarDays.map((day, index) => (
              <DayCell
                key={`${day.label}-${index}`}
                activeOpacity={0.8}
                onPress={() => handleDateSelect(day)}
              >
                <DayInner
                  isSelected={day.isSelected}
                  hasEntry={day.hasEntry}
                >
                  <DayNumber
                    isCurrentMonth={day.isCurrentMonth}
                    isSelected={day.isSelected}
                  >
                    {day.label}
                  </DayNumber>
                </DayInner>
              </DayCell>
            ))}
          </DaysGrid>
        </CalendarCard>

        {/* FECHA SELECCIONADA */}
        <SelectedDateWrapper>
          <SelectedDateText>{formatSelectedDate(selectedDate)}</SelectedDateText>
        </SelectedDateWrapper>

        {/* ENTRADAS O ESTADO VACÍO */}
        {selectedDateEntries.length > 0 ? (
          <EntriesContainer>
            {selectedDateEntries.map((entry) => (
              <DiaryEntryCard key={entry.id} entry={entry} />
            ))}
          </EntriesContainer>
        ) : (
          <EmptyStateWrapper>
            <EmptyIconWrapper>
              <Ionicons
                name="calendar-outline"
                size={32}
                color={Theme.colors.textTertiary}
              />
            </EmptyIconWrapper>
            <EmptyText>No hay entradas para este día</EmptyText>
          </EmptyStateWrapper>
        )}

        {/* ACCIONES INFERIORES (BOTÓN + FAB) */}
        <BottomActionsRow>
          <CreateEntryButton activeOpacity={0.9} onPress={handleCreateEntry}>
            <Ionicons
              name="add"
              size={18}
              color={Theme.colors.primary}
              style={{ marginRight: 6 }}
            />
            <CreateEntryText>Crear Entrada</CreateEntryText>
          </CreateEntryButton>

          <FabButton activeOpacity={0.9} onPress={handleCreateEntry}>
            <Ionicons name="add" size={26} color={Theme.colors.white} />
          </FabButton>
        </BottomActionsRow>
      </ContentScroll>

      {/* MODAL */}
      <DiaryEntryModal
        visible={modalVisible}
        selectedDate={selectedDate}
        onClose={() => setModalVisible(false)}
        onSubmit={handleEntrySubmit}
      />
    </Container>
  );
};

export default Diary;

/* ─────────────── STYLES ─────────────── */

const Container = styled.View`
  flex: 1;
  background-color: ${Theme.colors.background};
`;

const ContentScroll = styled.ScrollView`
  flex: 1;
`;

/* Header */

const TopHeader = styled.View`
  padding: ${Theme.spacing.space4}px ${Theme.spacing.space4}px 0;
  flex-direction: row;
  align-items: center;
  justify-content: space-between;
`;

const HeaderTitleRow = styled.TouchableOpacity`
  flex-direction: row;
  align-items: center;
`;

const HeaderTitle = styled.Text`
  font-size: ${Theme.typography.fontSizeLg}px;
  font-weight: 600;
  color: ${Theme.colors.textPrimary};
`;

const HeaderIconButton = styled.TouchableOpacity`
  padding-vertical: ${Theme.spacing.space1}px;
  padding-horizontal: ${Theme.spacing.space1}px;
`;

/* Calendar card */

const CalendarCard = styled.View`
  margin: ${Theme.spacing.space4}px ${Theme.spacing.space4}px 0;
  background-color: ${Theme.colors.white};
  border-radius: 24px;
  padding: ${Theme.spacing.space3}px ${Theme.spacing.space4}px
    ${Theme.spacing.space4}px;
  ${() => Theme.shadows.shadowSm}
`;

const CalendarHeaderRow = styled.View`
  flex-direction: row;
  justify-content: space-between;
  align-items: center;
  margin-bottom: ${Theme.spacing.space3}px;
`;

const MonthLabel = styled.Text`
  font-size: ${Theme.typography.fontSizeSm}px;
  font-weight: 600;
  color: ${Theme.colors.textPrimary};
`;

const MonthControls = styled.View`
  flex-direction: row;
  align-items: center;
`;

const MonthArrowButton = styled.TouchableOpacity`
  padding-vertical: ${Theme.spacing.space1}px;
  padding-horizontal: ${Theme.spacing.space1}px;
  margin-left: ${Theme.spacing.space1}px;
`;

const WeekDaysRow = styled.View`
  flex-direction: row;
  justify-content: space-between;
  margin-bottom: ${Theme.spacing.space2}px;
`;

const WeekDayText = styled.Text`
  width: 14.28%;
  text-align: center;
  font-size: ${Theme.typography.fontSizeXs}px;
  color: ${Theme.colors.textSecondary};
`;

/* Days grid */

const DaysGrid = styled.View`
  flex-direction: row;
  flex-wrap: wrap;
`;

const DayCell = styled.TouchableOpacity`
  width: 14.28%;
  height: 40px;
  align-items: center;
  justify-content: center;
`;

interface DayInnerProps {
  isSelected?: boolean;
  hasEntry?: boolean;
}

const DayInner = styled.View<DayInnerProps>`
  min-width: 32px;
  min-height: 32px;
  padding-vertical: 4px;
  padding-horizontal: 4px;
  border-radius: 16px;
  align-items: center;
  justify-content: center;
  background-color: ${({ isSelected }) =>
    isSelected ? Theme.colors.primary : "transparent"};
  border-width: ${({ hasEntry, isSelected }) =>
    hasEntry && !isSelected ? 2 : 0}px;
  border-color: ${Theme.colors.primary};
`;

interface DayNumberProps {
  isCurrentMonth: boolean;
  isSelected?: boolean;
}

const DayNumber = styled.Text<DayNumberProps>`
  font-size: ${Theme.typography.fontSizeSm}px;
  color: ${({ isCurrentMonth, isSelected }) =>
    isSelected
      ? Theme.colors.white
      : isCurrentMonth
        ? Theme.colors.textPrimary
        : Theme.colors.textTertiary};
`;

/* Selected date + empty state */

const SelectedDateWrapper = styled.View`
  margin-top: ${Theme.spacing.space4}px;
  padding-horizontal: ${Theme.spacing.space4}px;
`;

const SelectedDateText = styled.Text`
  font-size: ${Theme.typography.fontSizeSm}px;
  font-weight: 500;
  color: ${Theme.colors.textPrimary};
`;

const EntriesContainer = styled.View`
  margin-top: ${Theme.spacing.space4}px;
  padding-horizontal: ${Theme.spacing.space4}px;
`;

const EmptyStateWrapper = styled.View`
  margin-top: ${Theme.spacing.space5}px;
  align-items: center;
  justify-content: center;
`;

const EmptyIconWrapper = styled.View`
  width: 64px;
  height: 64px;
  border-radius: 32px;
  border-width: 1px;
  border-color: ${Theme.colors.textTertiary}33;
  align-items: center;
  justify-content: center;
  margin-bottom: ${Theme.spacing.space3}px;
`;

const EmptyText = styled.Text`
  font-size: ${Theme.typography.fontSizeSm}px;
  color: ${Theme.colors.textSecondary};
`;

/* Bottom actions */

const BottomActionsRow = styled.View`
  margin-top: ${Theme.spacing.space5}px;
  padding-horizontal: ${Theme.spacing.space4}px;
  flex-direction: row;
  align-items: center;
  justify-content: space-between;
`;

const CreateEntryButton = styled.TouchableOpacity`
  flex-direction: row;
  align-items: center;
  padding-vertical: ${Theme.spacing.space2}px;
  padding-horizontal: ${Theme.spacing.space4}px;
  border-radius: 999px;
  border-width: 1px;
  border-color: ${Theme.colors.primary};
  background-color: ${Theme.colors.white};
`;

const CreateEntryText = styled.Text`
  font-size: ${Theme.typography.fontSizeSm}px;
  font-weight: 500;
  color: ${Theme.colors.primary};
`;

const FabButton = styled.TouchableOpacity`
  width: 56px;
  height: 56px;
  border-radius: 28px;
  background-color: ${Theme.colors.primary};
  align-items: center;
  justify-content: center;
  ${() => Theme.shadows.shadowSm}
`;
